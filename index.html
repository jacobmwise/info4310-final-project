<!DOCTYPE html>
<html>
    <head>
        <title>INFO4310 Final Project - rcc263, jmw555</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>

        <style>
            html, body{
                background-color: black;
            }

            * {
                color: white;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }


            .nation {
                fill: slategray;
                stroke: white;
                stroke-width: 1px;
            }

            .outline {
                stroke: darkgrey;
                stroke-width: 0.5px;
                fill: none;
            }

            .gridlines g line{
                stroke: grey !important;
            }


        </style>
    </head>
    <body>
        <div style="text-align: center;">
            <h1>Moneyball</h1>
            <h3>Visualizing the Recent MLB Payroll Disparity, its Reasons, and its Effects</h3>

            <div style="display: flex;">
                <div style="width: 75%; overflow-y:scroll; height:80vh;">
                    <div style="display: flex; flex-direction: row; justify-content: center;">
                        <div id="scatter-key-container">
                            <svg id="scatter-key" width="250" height="250"></svg>
                        </div>
                        <svg id="scatterplot" width="600" height="550"></svg>
                    </div>

                    <div id="sliderDiv" style="display: flex; flex-direction: column; margin-top: 20px;">
                        <div id="slider"></div>
                    </div>

                    <svg id="choropleth" height="670" width="1000"></svg>
                </div>
                <div id="details-div" style="display: flex; flex-direction: column; width: 25%; padding-left: 12px; border-left-color: white; border-width: 1px; border-style: none none none solid;">
                    <div id="details-text" style="display: flex; flex-direction: column;  margin-bottom: 25px;"></div>
                    <svg id="teamLineGraph" height="250" width="300"></svg>
                    <svg id="histogram" height="300" width="300"></svg>
                </div>
            </div>
            <div id="citations" style="margin: 35px auto;">
                <h3>Data Sources:</h3>
                <!-- <ul> -->
                    <p>MLB Win % and WS Data - <a href="https://www.teamrankings.com/mlb/stat/win-pct-all-games?date=2021-11-03">GraceNote/Nielsen via TeamRankings</a></p>
                    <p>MLB Annual Payroll Data - <a href="http://www.stevetheump.com/Payrolls.htm">AP/MLB via SteveTheUmp.com</a></p>
                    <p>Metro Area GDP Data (US) - <a href=https://apps.bea.gov/itable/iTable.cfm?ReqID=70&step=1&acrdn=5">US DOC Bureau of Economic Activity</a></p>
                    <p>Metro Area GDP Data (Toronto) - <a href="https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3610046801&cubeTimeFrame.startYear=2011&cubeTimeFrame.endYear=2018&referencePeriods=20110101%2C20180101">Statistics Canada</a></p>
                    <p>City Population Data - <a href="">@JACOB put ur source here</a></p>
                    <p>Geographic Coordinate Data - <a href="https://gist.github.com/Miserlou/c5cd8364bf9b2420bb29">NPM via Miserlou on GitHub Gist</a></p>

                <!-- </ul> -->
            </div>

        </div>
        <script>
            const load = async function() {
                let payrollData = await d3.csv("data/payroll.csv");
                let gdpData = await d3.csv("data/gdp.csv");
                let populationData = await d3.csv("data/population.csv");
                let winsData = await d3.csv("data/wins.csv");

                let cityLocationsRaw = await d3.json("data/cities.json");

                let teamsMetroDict = {
                    "Boston": ["Red Sox"],
                    "New York": ['Yankees', "Mets"],
                    "Toronto": ['Blue Jays'],
                    "Philadelphia": ['Phillies'],
                    "Pittsburgh": ['Pirates'],
                    "Baltimore": ['Orioles'],
                    "Washington, DC": ['Nationals'],
                    "Detroit": ['Tigers'],
                    "Cleveland": ['Guardians'],
                    "Cincinnati": ['Reds'],
                    "Atlanta": ['Braves'],
                    "Tampa Bay": ['Rays'],
                    "Miami": ['Marlins'],
                    "Houston": ['Astros'],
                    "Dallas": ['Rangers'],
                    "Denver": ['Rockies'],
                    "Minneapolis": ['Twins'],
                    "Milwaukee": ['Brewers'],
                    "Chicago": ['Cubs', "White Sox"],
                    "San Diego": ['Padres'],
                    "Seattle": ['Mariners'],
                    "San Francisco": ['Giants', "Athletics"],
                    "Los Angeles": ['Dodgers', "Angels"],
                    "Kansas City": ['Royals'],
                    "St. Louis": ['Cardinals'],
                    "Phoenix": ['Diamondbacks']
                }

                let metroTeamsDict = {}

                Object.keys(teamsMetroDict).forEach(function(metro){
                    teamsMetroDict[metro].forEach(function(team){
                        metroTeamsDict[team] = metro
                    })
                })
                console.log(metroTeamsDict)

                payrollData.forEach(d => {
                    if (d['Total Payroll'].slice(0,1) === '$') {
                        d['Total Payroll'] = d['Total Payroll'].slice(1)
                    }
                    if (d['Total Payroll'].slice(-1) === 'M') {
                        // let decimalIndex = d['Total Payroll'].indexOf('.')
                        // let mIndex = d['Total Payroll'].indexOf('M')
                        // d['Total Payroll'] = d['Total Payroll'].slice(0,decimalIndex) + ',' + d['Total Payroll'].slice(decimalIndex + 1, mIndex)
                        // if (d['Total Payroll'].length === 5) {
                        //     d['Total Payroll'] = d['Total Payroll'] + '0,000'
                        // } else {
                        //     d['Total Payroll'] = d['Total Payroll'] + ',000'
                        // }
                        d['Total Payroll'] = (Number(d['Total Payroll'].substr(0, d['Total Payroll'].length-1)  * 1000000).toLocaleString())
                    }
                    d['Total Payroll'] = Number(d['Total Payroll'].split(',').join(''))
                    let team = winsData.filter((x) => { return (x['Team']===d['Team']) });
                    d['Win%'] = team[0][d['Year']]
                });
                console.log(payrollData);

                // SCATTER KEY
                d3.select("svg#scatter-key").append("path").attr("d", d3.symbol().type(d3.symbolStar).size(125)).attr("fill", "gold").attr("transform","translate("+30+","+130+")")
                d3.select("svg#scatter-key").append("path").attr("d", d3.symbol().type(d3.symbolStar).size(125)).attr("fill", "#1877F2").attr("transform","translate("+30+","+160+")")
                d3.select("svg#scatter-key").append("path").attr("d", d3.symbol().type(d3.symbolCircle).size(125)).attr("fill", "#1877F2").attr("transform","translate("+30+","+190+")")
                d3.select("svg#scatter-key").append("path").attr("d", d3.symbol().type(d3.symbolCircle).size(125)).attr("fill", "red").attr("transform","translate("+30+","+220+")")
                
                d3.select("svg#scatter-key").append("text").text("World Series Winner").style("font-size", 12).attr("fill", "white").attr("transform","translate("+60+","+135+")")
                d3.select("svg#scatter-key").append("text").text("World Series Runner-Up").style("font-size", 12).attr("fill", "white").attr("transform","translate("+60+","+165+")")
                d3.select("svg#scatter-key").append("text").text("Made Playoffs").style("font-size", 12).attr("fill", "white").attr("transform","translate("+60+","+195+")")
                d3.select("svg#scatter-key").append("text").text("Missed Playoffs").style("font-size", 12).attr("fill", "white").attr("transform","translate("+60+","+225+")")

            
                // SCATTER PLOT
                let currentData = payrollData.filter(x => { return x['Year'] === '2021'});
                var payrollExtent = d3.extent(currentData, d => d['Total Payroll']);
                var winsExtent = d3.extent(currentData, d => d['Win%']);

                const scatterplot = d3.select("#scatterplot");
                const scatterWidth = scatterplot.attr("width");
                const scatterHeight = scatterplot.attr("height");
                const scatterMargin = { top: 50, right: 50, bottom: 70, left: 70};
                const scatterAreaWidth = scatterWidth - scatterMargin.left - scatterMargin.right;
                const scatterAreaHeight = scatterHeight - scatterMargin.top - scatterMargin.bottom;

                let annotations = scatterplot.append("g").attr("id","annotations");
                const scatter = scatterplot.append("g")

                let winsScale = d3.scaleLinear().domain(winsExtent).range([scatterAreaHeight, 0]);
                let defScale = d3.scaleLinear().domain([10, -10]).range([0, scatterAreaHeight]);
                let payrollScale = d3.scaleLinear().domain(payrollExtent).range([0, scatterAreaWidth])

                let leftAxis = d3.axisLeft(winsScale)
                let leftGridlines = d3.axisLeft(winsScale)
                                    .tickSize(-scatterAreaWidth-10)
                                    .tickFormat("")
                let leftGridlinesG = annotations.append("g")
                    .attr("class", "y gridlines")
                    .attr("transform",`translate(${scatterMargin.left-10},${scatterMargin.top})`)
                    .call(leftGridlines);
                let leftAxisG = annotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform",`translate(${scatterMargin.left-10},${scatterMargin.top})`)
                    .call(leftAxis)
                
                let bottomAxis = d3.axisBottom(payrollScale)
                let bottomGridlines = d3.axisBottom(payrollScale)
                                        .tickSize(-scatterAreaHeight-10)
                                        .tickFormat(function(d) { return d/1000000 + 'M'});
                let bottomGridlinesG = annotations.append("g")
                    .attr("class", "x gridlines")
                    .attr("transform",`translate(${scatterMargin.left},${scatterAreaHeight+scatterMargin.top+10})`)
                    .call(bottomGridlines);
                let bottomAxisG =  annotations.append("g")
                    .attr("class", "x axis")
                    .attr("transform",`translate(${scatterMargin.left},${scatterAreaHeight+scatterMargin.top})`)
                    .call(bottomAxis)

                scatter.append("g")
                    .attr('transform', 'translate(' + (scatterAreaWidth/2 + scatterMargin.left) + ', ' + (scatterAreaHeight + (scatterMargin.top * 2)) + ')')
                    .append('text')
                    .text("Payroll (USD)")
                    .style("fill", "white")
                    .style("font-size", 14)
                    .attr('text-anchor', 'middle')
                scatter.append('g')
                    .attr('transform', 'translate(' + 15 + ', ' + (scatterAreaHeight/2 + scatterMargin.top) + ')')
                    .append('text')
                    .text("Win %")
                    .style("fill", "white")
                    .style("font-size", 14)
                    .attr('text-anchor', 'middle')
                    .attr('transform', 'rotate(-90)')

                function getNumericPixelVal(str){
                    return Number(String(str).substr(0, String(str).length-2))
                }

                
                let selectedTeam = null;
                let symbolMap = {'WSW': d3.symbol().type(d3.symbolStar).size(150), 'WSL': d3.symbol().type(d3.symbolStar).size(150), 'Y': d3.symbol().type(d3.symbolCircle).size(150), 'N': d3.symbol().type(d3.symbolCircle).size(150)}
                let symbolMap2 = {'WSW': d3.symbol().type(d3.symbolStar).size(100), 'WSL': d3.symbol().type(d3.symbolStar).size(100), 'Y': d3.symbol().type(d3.symbolCircle).size(100), 'N': d3.symbol().type(d3.symbolCircle).size(100)}
                
                function plotCircles(year) {
                    currentData = payrollData.filter(x => { return x['Year'] === year});
                    
                    payrollExtent = d3.extent(currentData, d => d['Total Payroll']);
                    winsExtent = d3.extent(currentData, d => d['Win%']);

                    winsScale = d3.scaleLinear().domain([Number(winsExtent[0])-0.05, Number(winsExtent[1])+0.05]).range([scatterAreaHeight, 0]);
                    payrollScale = d3.scaleLinear().domain([payrollExtent[0]-5000000, payrollExtent[1]+5000000]).range([0, scatterAreaWidth]);

                    leftAxis = d3.axisLeft(winsScale);
                    leftAxisG.transition().duration(350).call(leftAxis)
                    bottomAxis = d3.axisBottom(payrollScale);
                    bottomAxisG.transition().duration(350).call(bottomAxis)
                        .selectAll("text").text("")
                        
                        .style("text-anchor", "start");
                    leftGridlines = d3.axisLeft(winsScale)
                                        .tickSize(-scatterAreaWidth-10)
                                        .tickFormat("")
                    leftGridlinesG.transition().duration(350).call(leftGridlines);
                    bottomGridlines = d3.axisBottom(payrollScale)
                                        .tickSize(-scatterAreaHeight-10)
                                        .tickFormat(function(d) { return d/1000000 + 'M'});
                    bottomGridlinesG.transition().duration(350).call(bottomGridlines);
                    
                    scatter.selectAll("svg").remove()

                    let selectedCircleID = null;
                    let circles = scatter.selectAll("circle.team")
                        .data(currentData)
                        .join('svg')
                        .attr("id", d => d['Team'].split('.').join("").split(" ").join(""))
                        .attr("value", d => d['Team'])
                        .attr("x", d => payrollScale(d['Total Payroll']))
                        .attr("y", d => winsScale(d['Win%']))
                        .style("cursor", "pointer")
                        .on("mouseover", function(e, d) {
                            d3.select(this.children[0])
                                .raise()
                                .transition().duration(250)
                                .attr("d", symbolMap[d['Playoffs']])
                                

                            let tooltipWidth = 180;
                            let tooltipHeight = 70;
                            let tooltip = scatter.append("g")
                                .attr("class","tooltip")
                                .attr("opacity", .4)
                                .raise()
                            let tooltipX = (-tooltipWidth/2) + getNumericPixelVal(payrollScale(d["Total Payroll"]))+scatterMargin.left
                            if ((tooltipX+(tooltipWidth)>=scatterAreaWidth+scatterMargin.left)){
                                tooltipX = scatterAreaWidth+scatterMargin.left - (tooltipWidth)-2
                            } else if (tooltipX<=scatterMargin.left) {
                                tooltipX = scatterMargin.left + 2
                            }
                            if (d['Total Payroll'] === payrollExtent[1]) {
                                tooltipX = scatterAreaWidth+scatterMargin.left - (tooltipWidth)-2
                            }
                            let tooltipY = getNumericPixelVal(winsScale(d['Win%']))+scatterMargin.top-tooltipHeight-15
                            if ((tooltipY<=0)){
                                tooltipY = getNumericPixelVal(winsScale(d['Win%']))+scatterMargin.top+15
                            }

                            tooltip.append("rect")
                                .attr("fill", "white")
                                .attr("opacity", 1)
                                .attr("x", tooltipX)
                                .attr("y", tooltipY)
                                .attr("rx", "5")
                                .attr("ry", "5")
                                .attr("width",tooltipWidth)
                                .attr("height",tooltipHeight)
                                .attr("stroke", "lightgrey")
                                .attr("stroke-width", "1px")
                            let txt = tooltip.append("text")
                                .text(d['Team'])
                                .attr("fill", "black")
                                .attr("text-anchor","left")
                                .attr("alignment-baseline","hanging")
                                .attr("x", tooltipX+5)
                                .attr("y", tooltipY + 5)
                                .style("font-size", "13px");
                            let txt2 = tooltip.append("text")
                                .text(`Total Payroll: $${Number(d['Total Payroll']).toLocaleString()}`)
                                .attr("fill", "gray")
                                .attr("text-anchor","left")
                                .attr("alignment-baseline","hanging")
                                .attr("x", tooltipX+5)
                                .attr("y", tooltipY + 25)
                                .style("font-size", "12px");
                            let txt3 = tooltip.append("text")
                                .text(`Win%: ${(Number(d['Win%'])*100).toFixed(2)}%`)
                                .attr("fill", "gray")
                                .attr("text-anchor","left")
                                .attr("alignment-baseline","hanging")
                                .attr("x",tooltipX+5)
                                .attr("y", tooltipY + 40)
                                .style("font-size", "12px");
                            d3.select(".tooltip")
                                .raise()
                                .transition().duration(300)
                                .attr("opacity", 0.9)
                        })
                        .on("mouseout", function(e, d) {
                            d3.select(this.children[0])
                                .lower()
                                .transition().duration(250)
                                .attr("d", symbolMap2[d['Playoffs']])
                            d3.selectAll(".tooltip").remove()
                        })
                        .on("click", function(e, d) {
                            d3.select("#" + selectedCircleID + " path").transition().duration(250).attr("stroke", "none").attr("stroke-width", "0")
                            d3.select(this.children[0]).transition().duration(250).attr("stroke", "white").attr("stroke-width", "1.5px")

                            selectedCircleID = d3.select(this).attr("id")
                            selectedTeam = d['Team']
                            console.log(d['Total Payroll'])
                            d3.select("div#details-text").selectAll("h3").remove()
                            d3.select("div#details-text").selectAll("text").remove()

                            // buildSearch()
                            d3.select("div#details-text").append("h3").text(d['Team'])
                            d3.select("div#details-text").append("text").text(`${d['Year']} Payroll: $${d['Total Payroll'].toLocaleString()}`).style("text-align", "left")
                            d3.select("div#details-text").append("text").text(`Win Percentage: ${d['Win%']}`).style("text-align", "left")
                            if (d['Playoffs'] === 'WSW') {
                                d3.select("div#details-text").append("text").text("World Series Champion").style("text-align", "left")
                            } else if (d['Playoffs'] === 'WSL') {
                                d3.select("div#details-text").append("text").text("World Series Runner-Up").style("text-align", "left")
                            } else if (d['Playoffs'] === 'Y') {
                                d3.select("div#details-text").append("text").text("Made Playoffs").style("text-align", "left")
                            } else {
                                d3.select("div#details-text").append("text").text("Missed Playoffs").style("text-align", "left")
                            }

                            updateLineGraph(d['Team'])
                            d3.select("#teamLineGraph").style("display", "block")
                            highlightMapCircle(d['Team'])
                        });

                    

                    currentData.forEach(d => {
                        if (d['Playoffs'] === 'WSW') {
                            d3.select(`svg#${d['Team'].split('.').join("").split(" ").join("")}`)
                            .append("path")
                            .attr("d", d3.symbol().type(d3.symbolStar).size(100))
                            .attr("fill", "gold")
                            .attr("stroke", "black")
                            .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        } else if (d['Playoffs'] === 'WSL') {
                            d3.select(`svg#${d['Team'].split('.').join("").split(" ").join("")}`)
                            .append("path")
                            .attr("d", d3.symbol().type(d3.symbolStar).size(100))
                            .attr("fill", "#1877F2")
                            .attr("stroke", "black")
                            .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        } else if (d['Playoffs'] === 'Y') {
                            d3.select(`svg#${d['Team'].split('.').join("").split(" ").join("")}`)
                            .append("path")
                            .attr("d", d3.symbol().type(d3.symbolCircle).size(100))
                            .attr("fill", "#1877F2")
                            .attr("stroke", "black")
                            .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        } else {
                            d3.select(`svg#${d['Team'].split('.').join("").split(" ").join("")}`)
                            .append("path")
                            .attr("d", d3.symbol().type(d3.symbolCircle).size(100))
                            .attr("fill", "red")
                            .attr("stroke", "black")
                            .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        }
                    });
                }
                plotCircles('2021');

                // SCATTER SEARCH
                function buildSearch() {
                    d3.select("div#scatter-key-container").append("p").text("Search teams:").style("margin-top", "100px")
                    d3.select("div#scatter-key-container").append("input").attr("type", "text").style("color", "black")
                        .on("input", function(e) {
                            if (e.target.value === "") {
                                console.log("hi")
                                var unsearchedData = currentData
                                var searchedData = []
                            } else {
                                var searchedData = currentData.filter(d => { return d['Team'].toLowerCase().includes(e.target.value)})
                                var unsearchedData = currentData.filter(d => { return !d['Team'].toLowerCase().includes(e.target.value)})
                            }
                            searchedData.forEach(d => {
                                let team = d3.select(`svg#${d['Team'].split('.').join("").split(" ").join("")}`)
                                d3.select(team['_groups'][0][0].children[0]).style("stroke", "white")
                            })
                            unsearchedData.forEach(d => {
                                let team = d3.select(`svg#${d['Team'].split('.').join("").split(" ").join("")}`)
                                d3.select(team['_groups'][0][0].children[0]).style("stroke", "black")
                            })
                        });   
                }
                buildSearch()
                d3.select("div#details-text").append("h3").text("Click a team to view details")


                // TEAM LINE GRAPH

                let lineSVG = d3.select("#teamLineGraph")

                const lineWidth = lineSVG.attr("width");
                const lineHeight = lineSVG.attr("height");
                const lineMargin = { top: 5, right: 5, bottom: 60, left: 50};
                const lineAreaWidth = lineWidth - lineMargin.left - lineMargin.right;
                const lineAreaHeight = lineHeight - lineMargin.top - lineMargin.bottom;

                let lineAnnotations = lineSVG.append("g").attr("id","lineAnnotations");
                const lineGraph = lineSVG.append("g").attr("transform","translate("+lineMargin.left+","+lineMargin.top+")")

                let teamPayrollScale = d3.scaleLinear().domain([20000000,200000000]).range([lineAreaHeight, 0]);
                // let defScale = d3.scaleLinear().domain([10, -10]).range([0, scatterAreaHeight]);
                let timeScale = d3.scaleLinear().domain([2010.5,2021.5]).range([0, lineAreaWidth])

                let leftAxisLine = d3.axisLeft(teamPayrollScale).tickFormat(function(d) { return d/1000000 + 'M'});
                // let leftGridlines = d3.axisLeft(winsScale)
                //                     .tickSize(-scatterAreaWidth-10)
                //                     .tickFormat("")
                // let leftGridlinesG = annotations.append("g")
                //     .attr("class", "y gridlines")
                //     .attr("transform",`translate(${scatterMargin.left-10},${scatterMargin.top})`)
                //     .call(leftGridlines);
                let leftAxisLineG = lineAnnotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform",`translate(${lineMargin.left-10},${lineMargin.top})`)
                    .call(leftAxisLine)
                
                let bottomAxisLine = d3.axisBottom(timeScale).tickFormat((d,i) => {
                  return i%2 !== 0 ? " ": String(d);
                 });
                // let bottomGridlines = d3.axisBottom(payrollScale)
                //                         .tickSize(-scatterAreaHeight-10)
                //                         .tickFormat(function(d) { return d/1000000 + 'M'});
                // let bottomGridlinesG = annotations.append("g")
                //     .attr("class", "x gridlines")
                //     .attr("transform",`translate(${scatterMargin.left},${scatterAreaHeight+scatterMargin.top+10})`)
                //     .call(bottomGridlines);
                let bottomAxisLineG =  lineAnnotations.append("g")
                    .attr("class", "x axis")
                    .attr("transform",`translate(${lineMargin.left},${lineAreaHeight+lineMargin.top})`)
                    .call(bottomAxisLine)

                lineGraph.append("g")
                    .attr('transform', 'translate(' + (lineAreaWidth/2 + lineMargin.left - 50) + ', ' + (lineAreaHeight + (lineMargin.top - 10)) + ')')
                    .append('text')
                    .text("Year")
                    .style("fill", "white")
                    .style("font-size", 8)
                    .attr('text-anchor', 'middle')
                lineGraph.append('g')
                    .attr('transform', 'translate(' + 2 + ', ' + (lineAreaHeight/2 + lineMargin.top) + ')')
                    .append('text')
                    .text("Payroll (USD)")
                    .style("fill", "white")
                    .style("font-size", 8)
                    .attr('text-anchor', 'middle')
                    .attr('transform', 'rotate(-90)')


                function updateLineGraph(team) {
                    currentTeamData = payrollData.filter(x => { return x['Team'] === team});
                    
                    teamPayrollExtent = d3.extent(currentTeamData, d => d['Total Payroll']);

                    teamPayrollScale = d3.scaleLinear().domain([teamPayrollExtent[0]-500000, teamPayrollExtent[1]+500000]).range([lineAreaHeight, 0]);

                    leftAxisLine = d3.axisLeft(teamPayrollScale).tickFormat(function(d) { return d/1000000 + 'M'});;
                    leftAxisLineG.transition().duration(350).call(leftAxisLine)
                    // bottomAxisLine = d3.axisBottom(payrollScale);
                    // bottomAxisG.transition().duration(350).call(bottomAxis)
                        // .selectAll("text").text("")
                        
                        // .style("text-anchor", "start");
                    // leftGridlines = d3.axisLeft(winsScale)
                    //                     .tickSize(-scatterAreaWidth-10)
                    //                     .tickFormat("")
                    // leftGridlinesG.transition().duration(350).call(leftGridlines);
                    // bottomGridlines = d3.axisBottom(payrollScale)
                    //                     .tickSize(-scatterAreaHeight-10)
                    //                     .tickFormat(function(d) { return d/1000000 + 'M'});
                    // bottomGridlinesG.transition().duration(350).call(bottomGridlines);
                    
                    // lineGraph.selectAll("svg").remove()

                    var lineGen = d3.line()
                        .x(d => timeScale(d['Year']))
                        .y(d => teamPayrollScale(d['Total Payroll']))
                        .curve(d3.curveMonotoneX); 

                    let thisYear = d3.select('#yearSlider').node().value

                    d3.select(".payrollLine").remove()

                    let line = lineGraph.append("path")
                            .datum(currentTeamData)
                            .attr("class", "payrollLine")
                            .attr("fill", "none")
                            .attr("stroke", "skyblue")
                            .attr("stroke-width", 1.5)
                            .attr("d",lineGen)
                        
                    let circles = lineGraph.selectAll("circle").data(currentTeamData)
                        .join('circle')
                        .attr("id", d => d['Team'].split('.').join("").split(" ").join("") + d['Year'])
                        .attr("value", d => d['Total Payroll'])
                        .attr("cx", d => timeScale(d['Year']))
                        .attr("cy", d => teamPayrollScale(d['Total Payroll']))
                        .attr("r", 3)
                        .attr("fill", "skyblue")

                    d3.select(`#${team.split('.').join("").split(" ").join("") + thisYear}`).raise().transition().duration(250).attr("r", "5").attr("fill", "red")

                }

                // HISTOGRAM
                let histoSVG = d3.select("#histogram")
                const histoWidth = histoSVG.attr("width");
                const histoHeight = histoSVG.attr("height");
                const histoMargin = { top: 5, right: 5, bottom: 100, left: 50};
                const histoAreaWidth = histoWidth - histoMargin.left - histoMargin.right;
                const histoAreaHeight = histoHeight - histoMargin.top - histoMargin.bottom;

                let histoAnnotations = histoSVG.append("g").attr("id","histoAnnotations");
                const histogram = histoSVG.append("g").attr("transform","translate("+histoMargin.left+","+histoMargin.top+")")

                function buildHisto() {
                    let payrollExtent = d3.extent(currentData, d => d['Total Payroll']);
                    payrollScale = d3.scaleLinear().domain([payrollExtent[0]-500000, payrollExtent[1]+500000]).range([histoAreaHeight, 0]);

                    let leftAxisHisto = d3.axisLeft(payrollScale).tickFormat(function(d) { return d/1000000 + 'M'});
                    let leftAxisHistoG = histoAnnotations.append("g")
                        .attr("class", "y axis")
                        .attr("transform",`translate(${histoMargin.left-10},${histoMargin.top})`)
                        .call(leftAxisHisto)
                    
                    

                    let teamPayrolls= {}
                    currentData.forEach(d => {
                        if (d['Team'].includes('Sox')) {
                            let name = d['Team'].split(' ') 
                            teamPayrolls[name.at(-2) + ' ' + name.at(-1)] = d['Total Payroll']
                        } else {
                            teamPayrolls[d['Team'].split(' ').at(-1)] = d['Total Payroll']
                        }
                    });
                    const teamScale = d3.scaleBand().domain(Object.keys(teamPayrolls)).range([0, histoAreaWidth])

                    let bottomAxisHisto = d3.axisBottom(teamScale).tickFormat((d,i) => {
                        return d;
                    });
                    let bottomAxisHistoG =  histoAnnotations.append("g")
                        .attr("class", "x axis")
                        .attr("transform",`translate(${histoMargin.left},${histoAreaHeight+histoMargin.top})`)
                        .call(bottomAxisHisto)
                        .selectAll("text")
                        .attr("y", 0)
                        .attr("x", 9)
                        .attr("dy", ".35em")
                        .attr("transform", "rotate(90)")
                        .style("text-anchor", "start");

                    histogram.append("g")
                        .attr('transform', 'translate(' + (histoAreaWidth/2 + histoMargin.left - 50) + ', ' + (histoAreaHeight + (histoMargin.top - 10)) + ')')
                        .append('text')
                        .text("Team")
                        .style("fill", "white")
                        .style("font-size", 8)
                        .attr('text-anchor', 'middle')
                    histogram.append('g')
                        .attr('transform', 'translate(' + 2 + ', ' + (histoAreaHeight/2 + histoMargin.top) + ')')
                        .append('text')
                        .text("Payroll (USD)")
                        .style("fill", "white")
                        .style("font-size", 8)
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'rotate(-90)')

                    histogram.selectAll('rect.bar').data(currentData)
                        .join('rect').attr("class", "bar")
                        .attr("id", d => d["Team"])
                        .attr("fill", "skyblue")
                        .attr("x", function(d) {
                            if (d['Team'].includes('Sox')) {
                                let name = d['Team'].split(' ') 
                                // teamPayrolls[name.at(-2) + ' ' + name.at(-1)] = d['Total Payroll']
                                return teamScale(name.at(-2) + ' ' + name.at(-1))
                            } else {
                                return teamScale(d["Team"].split(' ').at(-1))
                            }
                        })
                        .attr("y", d => payrollScale(d["Total Payroll"]))
                        .attr("height", d => (payrollScale(1) - payrollScale(d["Total Payroll"]) - (payrollScale(1) - payrollScale(payrollExtent[0]))))
                        .attr("width", 10)
                        .attr("opacity", 0.7)
                        // .attr("transform","translate("+histoMargin.left+","+histoMargin.top+")")
                }
                buildHisto()

                




                // SLIDER
                var slider = d3.select('div#slider').append('input')
                    .attr('type', 'range').attr('id', 'yearSlider').attr('step', 1)
                    .attr('min', 2011).attr('max', 2021).attr('value', 2021)
                    .attr("list", "steplist")
                    .style("width", "400px")
                    .style("margin", "0 15px 10px 0")

                //slider ticks
                var datalist = d3.select('div#slider').append('datalist').attr("id", "steplist")

                for (let i=2011; i<=2021; i++){
                    datalist.append("option").html(i)
                }

                d3.select('div#slider').append('label').attr('id', 'sliderLabel').text('2021')
                slider.on('input', function(e) {
                    d3.select('label#sliderLabel').text(e.target.value);
                });
                d3.select('div#sliderDiv').append('label').text('Year')

                slider.on('change', function(e) {
                    plotCircles(e.target.value);
                    buildHisto()
                    updateLineGraph(selectedTeam)
                });
                

                // MAP
                gdpData.forEach(metro => {
                    metro['2020'] = Number(metro['2020'])
                })

                let gdpExtent = d3.extent(gdpData, d => d['2020']);

                let gdpScale = d3.scaleLinear().domain(gdpExtent).range([20, 80]);

                let cities = []
                let cityLocations = []
                let citiesDict = {}

                populationData.forEach(city => {
                    if ((!cities.includes(city['City'])) && (city['City'] != "Oakland")){
                        cities.push(city['City'])
                    }
                })

                //map team logos and gdps to cities
                cityLocationsRaw.forEach(city => {
                    if (cities.includes(city['city'])){
                        gdpData.forEach(metro => {
                            if (metro['Metropolitan Area'].includes(city['city'])){
                                city['gdp'] = metro['2020']
                                if ( ['New York', "Los Angeles", "Chicago", "Washington, DC", "San Francisco"].includes(city['city']) ){
                                    if (city['city']=="New York"){
                                        city['logos'] = ["logos/light/newyorky_l.svg", "logos/light/newyorkm_l.svg"]
                                    } else if (city['city']=="Los Angeles"){
                                        city['logos'] = ["logos/light/losangelesd_l.svg", "logos/light/losangelesa_l.svg"]
                                    } else if (city['city']=="Chicago"){
                                        city['logos'] = ["logos/light/chicagoc_l.svg", "logos/light/chicagows_l.svg"]
                                    } else if (city['city']=="Washington, DC"){
                                        city['logos'] = ["logos/light/washington_l.svg"]
                                    } else if (city['city']=="San Francisco"){
                                        city['logos'] = ["logos/light/sanfrancisco_l.svg","logos/light/oakland_l.svg"]
                                    } 
                                } else {
                                    city['logos'] = ["logos/light/" + city['city'].toLowerCase().replace(" ", "").replace(".", "") + "_l.svg"]
                                }
                            }
                        })
                        cityLocations.push(city)
                        citiesDict[city['city']] = city
                    } 
                })
                

                payrollData.forEach(d => {
                    if (d['Playoffs'] === "") {
                        d['Playoffs'] = "N"
                    }
                });

                const map = d3.select("#choropleth")

                const us = await d3.json("/data/counties-10m.json");
                var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
                var path = d3.geoPath().projection(projection);

                var nation = topojson.feature(us, us.objects.nation);
                var states = topojson.feature(us, us.objects.states);
                var statesMesh = topojson.mesh(us, us.objects.states);

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                //hide alaska and hawaii
                map.append("rect")
                    .attr("fill", "black")
                    .attr("x", 0)
                    .attr("y", 460)
                    .attr("height", 170)
                    .attr("width", 300)

                map.append("rect")
                    .attr("fill", "black")
                    .attr("x", 300)
                    .attr("y", 550)
                    .attr("height", 150)
                    .attr('width', 100)

                const mouseover = map.append("g").attr("class","mouseover")
                       .attr("transform",`translate(${0},${500})`)
                       .raise();

                const frame = mouseover.append("rect").attr("class","frame")
                    .attr("x", 0).attr("y", 0)
                    .attr("height", 93)
                    .attr("width", 300)
                    .attr("fill", "rgba(219, 234, 255, 0.9)")
                    .attr("stroke", "navy")
                    .attr("rx", 10)
                    .raise();
        
                const textbox = mouseover.append("g").attr("transform","translate(10,10)").raise();

                mouseover.style("opacity", 0);

                function updateMouseover(city, textbox) {
                
                    //empty existing text
                    textbox.html('');

                    //set new text
                    textbox.append("text").text(city['city'] + " Metro Area")
                        .attr("x", 0).attr("y", 10).style("font-weight", "bold");
                    textbox.append("text").text("Team(s): " + teamsMetroDict[city['city']])
                        .attr("x", 0).attr("y", 30);
                    textbox.append("text").text("Population: " + Number(city['population']).toLocaleString())
                        .attr("x", 0).attr("y", 50);
                    textbox.append("text").text("Est. 2020 GDP: $" + city['gdp'].toLocaleString())
                        .attr("x", 0).attr("y", 70);
                
                }

                var nodes = map.append("g").selectAll("g").data(cityLocations)
                    .enter().append("g")
                        .attr("class", "circleG")
                        .attr("id", d => d['city'].toLowerCase().replace(" ", "").replace(".", "").replace(",", ""))
                        .attr("transform", d => `translate(${projection([d['longitude'], d['latitude']])[0]}, ${ projection([d['longitude'], d['latitude']])[1]})`)
                        // .attr("y", d => projection([d['longitude'], d['latitude']])[1])
                    .append("circle")
                    .attr("r", d => gdpScale(d['gdp']))
                    .attr("opacity", 0.6)
                    .attr("fill", "green")
                    .attr("cx",0)
                    .attr("cy", 0)
                    .attr("data-city", d => d['city'])
                    .attr("stroke", "white")
                    // .on("mouseover", function(e, d){
                    //     console.log(d)
                    //     mouseover.transition().duration(300).style("opacity",1);
                    //     updateMouseover(d, textbox);
                    // })
                    // .on("mouseout", function(){
                    //     mouseover.transition().duration(300).style("opacity",0);
                    // })

                    var simulation = d3.forceSimulation()
                        // .force("center", d3.forceCenter().x(300).y(200)) // Attraction to the center of the svg area
                        // .force("charge", d3.forceManyBody().strength(0.5)) // Nodes are attracted one each other of value is > 0
                        .force("collide", d3.forceCollide().strength(0.2).radius(d => gdpScale(d['gdp'])).iterations(1)) // Force that avoids circle overlapping
                        .force("x", d3.forceX(d => projection([d['longitude'], d['latitude']])[0]))
                        .force("y", d3.forceY(d => projection([d['longitude'], d['latitude']])[1]))


                    

                    // simulation
                    //     .nodes(cityLocations)
                    //     .on("tick", function(d){
                    //     nodes
                    //         // .attr("cx", d => projection([d['longitude'], d['latitude']])[0])
                    //         // .attr("cy", d => projection([d['longitude'], d['latitude']])[1])
                    //     });

                    var simulation = d3.forceSimulation()
                        .force("collide", d3.forceCollide().strength(0.2).radius(d => gdpScale(d['gdp'])).iterations(1)) // Force that avoids circle overlapping
                        .force("x", d3.forceX(d => projection([d['longitude'], d['latitude']])[0]))
                        .force("y", d3.forceY(d => projection([d['longitude'], d['latitude']])[1]))

                // // add pseudo locations to display cities' second teams
                // cityLocations.push(
                //     {
                //         "city": "Queens", 
                //         "latitude": 40.8127837, 
                //         "longitude": -73.2059413, 
                //         "state": "New York",
                //         "logos": ["logos/light/newyorkm_l.svg"]
                //     }
                // )
                // cityLocations.push(
                //     {
                //         "city": "Anaheim", 
                //         "latitude": 33.6922342, 
                //         "longitude": -117.5436849, 
                //         "state": "California",
                //         "logos": ["logos/light/losangelesa_l.svg"]
                //     })
                // cityLocations.push(
                //     {
                //         "city": "South Chicago", 
                //         "latitude": 41.2781136, 
                //         "longitude": -87.6297982, 
                //         "state": "Illinois",
                //         "logos": ["logos/light/chicagows_l.svg"]
                //     })

                // cityLocations.push(
                //     {
                //         "city": "Oakland", 
                //         "latitude": 38.4043637, 
                //         "longitude": -122.2711137, 
                //         "state": "Illinois",
                //         "logos": ["logos/light/oakland_l.svg"]
                //     })
               
                //add logos into circles
                nodes._groups[0].forEach(function(node){
                    let circle = d3.select(node)
                    let city = citiesDict[circle.attr("data-city")]
                    
                    let offset = -10;
                    if (city['logos'].length > 1){
                        offset = -20
                    }
                    city['logos'].forEach( function(logo){
                        let logoG = d3.select(`g#${circle.attr("data-city").toLowerCase().replace(" ", "").replace(".", "").replace(",", "")}`)

                        logoG.append(`image`)
                            .attr("opacity", 0.9)
                            .attr("height", "20px")
                            .attr("width", "20px")
                            .attr("x", offset )
                            .attr("y", -10 )
                            .attr("href", logo)
                            .attr("data-city", city)

                        offset += 22;
                    })

                })

                //invisible nodes for mouseovers (to prevent logo interference)
                let mouseoverNodes = map.selectAll("circle.mouseoverCircles").data(cityLocations)
                    .join("circle")
                    .attr("class", "mouseoverCircles")
                    .attr("r", d => gdpScale(d['gdp']))
                    .attr("opacity", 0)
                    .attr("fill", "green")
                    .attr("cx", d => projection([d['longitude'], d['latitude']])[0])
                    .attr("cy", d => projection([d['longitude'], d['latitude']])[1])
                    .attr("data-city", d => d['city'])
                    .attr("stroke", "none")
                    .attr("cursor", "pointer")
                    .on("mouseover", function(e, d){
                        console.log(d)
                        mouseover.transition().duration(300).style("opacity",1);
                        updateMouseover(d, textbox);
                    })
                    .on("mouseout", function(){
                        mouseover.transition().duration(300).style("opacity",0);
                    })
                    .on("click", function(e, d){
                        let clickedTeam = teamsMetroDict[d['city']][0]
                        let scatterID = null;

                        if ( ['Twins', "Diamondbacks", "Rangers", "Nationals", "Rockies"].includes(clickedTeam) ){
                                    if (clickedTeam=="Twins"){
                                        scatterID = "#MinnesotaTwins";
                                    } else if (clickedTeam=="Diamondbacks"){
                                        scatterID = "#ArizonaDiamondbacks";
                                    } else if (clickedTeam=="Rangers"){
                                        scatterID = "#TexasRangers";
                                    } else if (clickedTeam=="Nationals"){
                                        scatterID = "#WashingtonNationals";
                                    } else if (clickedTeam=="Rockies"){
                                        scatterID = "#ColoradoRockies";
                                    } 
                                } else {
                                    scatterID = `#${d['city'].replace(" ", "").replace(".", "").replace(",", "") + clickedTeam.replace(" ", "")}`;
                                }

                        d3.select(scatterID).dispatch('click')
                    })

                //set simulation nodes to g tags so logos move with circles
                let parentNodes = []
                nodes._groups[0].forEach( function(node){
                    parentNodes.push(node.parentElement)
                })
                parentNodes = d3.selectAll(parentNodes)

                //run simulation
                simulation
                    .nodes(cityLocations)
                    .on("tick", function(d){
                        parentNodes
                            .attr("transform", d => `translate(${d.x}, ${d.y })`)
                        
                        mouseoverNodes
                            .attr("cx", d => d.x )
                            .attr("cy", d => d.y )
                        
                    });


                function highlightMapCircle(fullteam){
                    let thisMetro = null;
                    Object.keys(metroTeamsDict).forEach(function(team){
                    // teamsMetroDict[metro].forEach(function(team){
                    //     metroTeamsDict[team] = metro
                    // })
                        if (fullteam.includes(team)){
                            thisMetro=metroTeamsDict[team]
                        }
                    })
                    let thisMetroID = thisMetro.toLowerCase().replace(" ", "").replace(".", "").replace(",", "");
                    console.log(thisMetroID)
                    d3.selectAll(".circleG circle").transition().duration(250).attr("fill", "green").attr("opacity", 0.6)
                    d3.select(`#${thisMetroID} circle`).transition().duration(250).attr("fill", "skyblue").attr("opacity", 0.9)
                }
            }
            load();
        </script>
    </body>
</html>