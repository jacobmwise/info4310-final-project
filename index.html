<!DOCTYPE html>
<html>
    <head>
        <title>INFO4310 Final Project - rcc263, jmw555</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>

        <style>
            html, body{
                background-color: black;
            }

            * {
                color: white;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }


            .nation {
                fill: slategray;
                stroke: white;
                stroke-width: 1px;
            }

            .outline {
                stroke: darkgrey;
                stroke-width: 0.5px;
                fill: none;
            }

            /* .state{
                cursor: pointer;
            } */

        </style>
    </head>
    <body>
        <div style="text-align: center;">
            <h1>Moneyball</h1>
            <h3>Visualizing the Recent MLB Payroll Disparity, its Reasons, and its Effects</h3>

            <svg id="scatterplot" width="500" height="500"></svg>

            <div id="sliderDiv" style="display: flex; flex-direction: column;">
                <div id="slider"></div>
            </div>

            <svg id="choropleth" height="670" width="975"></svg>

        </div>
        <script>
            const load = async function() {
                let payrollData = await d3.csv("data/payroll.csv");
                let gdpData = await d3.csv("data/gdp.csv");
                let populationData = await d3.csv("data/population.csv");
                let winsData = await d3.csv("data/wins.csv");

                let cityLocationsRaw = await d3.json("data/cities.json");

                payrollData.forEach(d => {
                    if (d['Total Payroll'].slice(0,1) === '$') {
                        d['Total Payroll'] = d['Total Payroll'].slice(1)
                    }
                    if (d['Total Payroll'].slice(-1) === 'M') {
                        let decimalIndex = d['Total Payroll'].indexOf('.')
                        let mIndex = d['Total Payroll'].indexOf('M')
                        d['Total Payroll'] = d['Total Payroll'].slice(0,decimalIndex) + ',' + d['Total Payroll'].slice(decimalIndex + 1, mIndex)
                        if (d['Total Payroll'].length === 5) {
                            d['Total Payroll'] = d['Total Payroll'] + '0,000'
                        } else {
                            d['Total Payroll'] = d['Total Payroll'] + ',000'
                        }
                    }
                    d['Total Payroll'] = Number(d['Total Payroll'].split(',').join(''))
                    let team = winsData.filter((x) => { return (x['Team']===d['Team']) });
                    d['Win%'] = team[0][d['Year']]
                });
                console.log(payrollData);

                // SCATTER PLOT
                let currentData = payrollData.filter(x => { return x['Year'] === '2021'});
                var payrollExtent = d3.extent(currentData, d => d['Total Payroll']);
                var winsExtent = d3.extent(currentData, d => d['Win%']);

                const scatterplot = d3.select("#scatterplot");
                const scatterWidth = scatterplot.attr("width");
                const scatterHeight = scatterplot.attr("height");
                const scatterMargin = { top: 50, right: 50, bottom: 50, left: 50};
                const scatterAreaWidth = scatterWidth - scatterMargin.left - scatterMargin.right;
                const scatterAreaHeight = scatterHeight - scatterMargin.top - scatterMargin.bottom;

                let annotations = scatterplot.append("g").attr("id","annotations");
                const scatter = scatterplot.append("g")

                let winsScale = d3.scaleLinear().domain(winsExtent).range([scatterAreaHeight, 0]);
                let defScale = d3.scaleLinear().domain([10, -10]).range([0, scatterAreaHeight]);
                let payrollScale = d3.scaleLinear().domain(payrollExtent).range([0, scatterAreaWidth])

                let leftAxis = d3.axisLeft(winsScale)
                let leftGridlines = d3.axisLeft(winsScale)
                                    .tickSize(-scatterAreaWidth-10)
                                    .tickFormat("")
                let leftGridlinesG = annotations.append("g")
                    .attr("class", "y gridlines")
                    .attr("transform",`translate(${scatterMargin.left-10},${scatterMargin.top})`)
                    .call(leftGridlines);
                let leftAxisG = annotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform",`translate(${scatterMargin.left-10},${scatterMargin.top})`)
                    .call(leftAxis)
                
                let bottomAxis = d3.axisBottom(payrollScale)
                let bottomGridlines = d3.axisBottom(payrollScale)
                                        .tickSize(-scatterAreaHeight-10)
                                        .tickFormat(function(d) { return d/1000000 + 'M'});
                let bottomGridlinesG = annotations.append("g")
                    .attr("class", "x gridlines")
                    .attr("transform",`translate(${scatterMargin.left},${scatterAreaHeight+scatterMargin.top+10})`)
                    .call(bottomGridlines);
                let bottomAxisG =  annotations.append("g")
                    .attr("class", "x axis")
                    .attr("transform",`translate(${scatterMargin.left},${scatterAreaHeight+scatterMargin.top})`)
                    .call(bottomAxis)

                // scatter.append("g")
                //     .attr('transform', 'translate(' + scatterAreaWidth/2 + ', ' + scatterAreaHeight + ')')
                //     .append('text')
                //     .text("Payroll (USD)")
                //     .attr('text-anchor', 'middle')
                // scatter.append('g')
                //     .attr('transform', 'translate(' + 15 + ', ' + scatterAreaHeight/2 + ')')
                //     .append('text')
                //     .attr('text-anchor', 'middle')
                //     .attr('transform', 'rotate(-90)')
                //     .text("Win %")

                function getNumericPixelVal(str){
                    return Number(String(str).substr(0, String(str).length-2))
                }

                let symbolMap = {'WSW': d3.symbol().type(d3.symbolStar).size(125), 'WSL': d3.symbol().type(d3.symbolStar).size(125), 'Y': d3.symbol().type(d3.symbolCircle).size(125), 'N': d3.symbol().type(d3.symbolCircle).size(125)}
                let symbolMap2 = {'WSW': d3.symbol().type(d3.symbolStar).size(75), 'WSL': d3.symbol().type(d3.symbolStar).size(75), 'Y': d3.symbol().type(d3.symbolCircle).size(75), 'N': d3.symbol().type(d3.symbolCircle).size(75)}
                
                function plotCircles(year) {
                    currentData = payrollData.filter(x => { return x['Year'] === year});
                    
                    payrollExtent = d3.extent(currentData, d => d['Total Payroll']);
                    winsExtent = d3.extent(currentData, d => d['Win%']);

                    winsScale = d3.scaleLinear().domain(winsExtent).range([scatterAreaHeight, 0]);
                    payrollScale = d3.scaleLinear().domain(payrollExtent).range([0, scatterAreaWidth]);
                    
                    leftAxis = d3.axisLeft(winsScale);
                    leftAxisG.transition().duration(350).call(leftAxis)
                    bottomAxis = d3.axisBottom(payrollScale);
                    bottomAxisG.transition().duration(350).call(bottomAxis)
                        .selectAll("text").text("")
                        
                        .style("text-anchor", "start");
                    leftGridlines = d3.axisLeft(winsScale)
                                        .tickSize(-scatterAreaWidth-10)
                                        .tickFormat("")
                    leftGridlinesG.transition().duration(350).call(leftGridlines);
                    bottomGridlines = d3.axisBottom(payrollScale)
                                        .tickSize(-scatterAreaHeight-10)
                                        .tickFormat(function(d) { return d/1000000 + 'M'});
                    bottomGridlinesG.transition().duration(350).call(bottomGridlines);
                    
                    scatter.selectAll("svg").remove()

                    let circles = scatter.selectAll("circle.team")
                        .data(currentData)
                        .join('svg')
                        .attr("id", d => d['Team'].split(" ").join(""))
                        .attr("value", d => d['Team'])
                        .attr("x", d => payrollScale(d['Total Payroll']))
                        .attr("y", d => winsScale(d['Win%']))
                        .on("mouseover", function(e, d) {
                            d3.select(this.children[0])
                                .raise()
                                .attr("d", symbolMap[d['Playoffs']])
                                .transition().duration(250)

                            let tooltipWidth = 180;
                            let tooltipHeight = 70;
                            let tooltip = scatter.append("g")
                                .attr("class","tooltip")
                                .attr("opacity", .4)
                                .raise()
                            let tooltipX = (-tooltipWidth/2) + getNumericPixelVal(payrollScale(d["Total Payroll"]))+scatterMargin.left
                            if ((tooltipX+(tooltipWidth)>=scatterAreaWidth+scatterMargin.left)){
                                tooltipX = scatterAreaWidth+scatterMargin.left - (tooltipWidth)-2
                            } else if (tooltipX<=scatterMargin.left) {
                                tooltipX = scatterMargin.left + 2
                            }
                            let tooltipY = getNumericPixelVal(winsScale(d['Win%']))+scatterMargin.top-tooltipHeight-15
                            if ((tooltipY<=0)){
                                tooltipY = getNumericPixelVal(winsScale(d['Win%']))+scatterMargin.top+15
                            }

                            tooltip.append("rect")
                                .attr("fill", "white")
                                .attr("opacity", 1)
                                .attr("x", tooltipX)
                                .attr("y", tooltipY)
                                .attr("rx", "5")
                                .attr("ry", "5")
                                .attr("width",tooltipWidth)
                                .attr("height",tooltipHeight)
                                .attr("stroke", "lightgrey")
                                .attr("stroke-width", "1px")
                            let txt = tooltip.append("text")
                                .text(d['Team'])
                                .attr("fill", "black")
                                .attr("text-anchor","left")
                                .attr("alignment-baseline","hanging")
                                .attr("x", tooltipX+5)
                                .attr("y", tooltipY + 5)
                                .style("font-size", "13px");
                            let txt2 = tooltip.append("text")
                                .text(`Total Payroll: $${d['Total Payroll']}`)
                                .attr("fill", "gray")
                                .attr("text-anchor","left")
                                .attr("alignment-baseline","hanging")
                                .attr("x", tooltipX+5)
                                .attr("y", tooltipY + 25)
                                .style("font-size", "12px");
                            let txt3 = tooltip.append("text")
                                .text(`Win%: ${(Number(d['Win%'])*100).toFixed(2)}%`)
                                .attr("fill", "gray")
                                .attr("text-anchor","left")
                                .attr("alignment-baseline","hanging")
                                .attr("x",tooltipX+5)
                                .attr("y", tooltipY + 40)
                                .style("font-size", "12px");
                            d3.select(".tooltip")
                                .raise()
                                .transition().duration(300)
                                .attr("opacity", 0.9)
                        })
                        .on("mouseout", function(e, d) {
                            d3.select(this.children[0])
                                .lower()
                                .attr("d", symbolMap2[d['Playoffs']])
                                .transition().duration(250)
                            d3.selectAll(".tooltip").remove()
                        });

                    

                    currentData.forEach(d => {
                        if (d['Playoffs'] === 'WSW') {
                            d3.select(`svg#${d['Team'].split(" ").join("")}`)
                            .append("path")
                            .attr("d", d3.symbol().type(d3.symbolStar).size(75))
                            .attr("fill", "gold")
                            .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        } else if (d['Playoffs'] === 'WSL') {
                            d3.select(`svg#${d['Team'].split(" ").join("")}`)
                            .append("path")
                            .attr("d", d3.symbol().type(d3.symbolStar).size(75))
                            .attr("fill", "red")
                            .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        } else if (d['Playoffs'] === 'Y') {
                            d3.select(`svg#${d['Team'].split(" ").join("")}`)
                            .append("path")
                            .attr("d", d3.symbol().type(d3.symbolCircle).size(75))
                            .attr("fill", "red")
                            .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        } else {
                            d3.select(`svg#${d['Team'].split(" ").join("")}`)
                            .append("path")
                            .attr("d", d3.symbol().type(d3.symbolCircle).size(75))
                            .attr("fill", "white")
                            .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        }
                    });
                }
                plotCircles('2021');

                // SLIDER
                var slider = d3.select('div#slider').append('input')
                    .attr('type', 'range').attr('id', 'yearSlider').attr('step', 1)
                    .attr('min', 2011).attr('max', 2021).attr('value', 2021)
                d3.select('div#slider').append('label').attr('id', 'sliderLabel').text('2021')
                slider.on('input', function(e) {
                    d3.select('label#sliderLabel').text(e.target.value);
                });
                d3.select('div#sliderDiv').append('label').text('Year')

                slider.on('change', function(e) {
                    plotCircles(e.target.value);
                });
                

                // MAP
                gdpData.forEach(metro => {
                    metro['2020'] = Number(metro['2020'])
                })

                let gdpExtent = d3.extent(gdpData, d => d['2020']);

                let gdpScale = d3.scaleLog().domain(gdpExtent).range([3, 25]);

                // console.log(gdpExtent)

                let cities = []
                let cityLocations = []

                populationData.forEach(city => {
                    if (!cities.includes(city['City'])){
                        cities.push(city['City'])
                    }
                })

                // console.log(cities)

                cityLocationsRaw.forEach(city => {
                    if (cities.includes(city['city'])){
                        gdpData.forEach(metro => {
                            if (metro['Metropolitan Area'].includes(city['city'])){
                                city['gdp'] = metro['2020']
                                // console.log(city['city'])
                                if ( ['New York', "Los Angeles", "Chicago", "Washington, DC"].includes(city['city']) ){
                                    if (city['city']=="New York"){
                                        city['logos'] = ["logos/light/newyorky_l.svg", "logos/light/newyorkm_l.svg"]
                                    } else if (city['city']=="Los Angeles"){
                                        city['logos'] = ["logos/light/losangelesd_l.svg", "logos/light/losangelesa_l.svg"]
                                    } else if (city['city']=="Chicago"){
                                        city['logos'] = ["logos/light/chicagoc_l.svg", "logos/light/chicagows_l.svg"]
                                    } else if (city['city']=="Washington, DC"){
                                        city['logos'] = ["logos/light/washington_l.svg"]
                                        console.log("oy")
                                    }
                                } else {
                                    city['logos'] = ["logos/light/" + city['city'].toLowerCase().replace(" ", "").replace(".", "") + "_l.svg"]
                                }
                            }
                        })
                        cityLocations.push(city)
                    } 
                    // console.log(city['city'])
                })
                

                payrollData.forEach(d => {
                    if (d['Playoffs'] === "") {
                        d['Playoffs'] = "N"
                    }
                });
                // console.log(payrollData);
                // console.log(gdpData);
                // console.log(populationData);
                // console.log(winsData);

                const map = d3.select("#choropleth")

                const us = await d3.json("/data/counties-10m.json");
                var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
                var path = d3.geoPath().projection(projection);

                var nation = topojson.feature(us, us.objects.nation);
                var states = topojson.feature(us, us.objects.states);
                var statesMesh = topojson.mesh(us, us.objects.states);

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                console.log(cityLocations)

                map.selectAll("circle").data(cityLocations)
                    .join("circle")
                    // .attr("r", d => diameterScale(d['DBH']))
                    .attr("r", d => gdpScale(d['gdp']))
                    .attr("opacity", 0.6)
                    // .attr("fill", d => speciesScale(d['qSpecies']))
                    .attr("fill", "green")
                    .attr("cx", d => projection([d['longitude'], d['latitude']])[0])
                    .attr("cy", d => projection([d['longitude'], d['latitude']])[1])
                    .attr("data-city", d => d['city'])
                    .attr("stroke", "white")


                // add pseudo locations to display cities' second teams
                cityLocations.push(
                    {
                        "city": "Queens", 
                        "latitude": 40.7127837, 
                        "longitude": -73.0059413, 
                        "state": "New York",
                        "logos": ["logos/light/newyorkm_l.svg"]
                    }
                )
                cityLocations.push(
                    {
                        "city": "Anaheim", 
                        "latitude": 33.6922342, 
                        "longitude": -117.5436849, 
                        "state": "California",
                        "logos": ["logos/light/losangelesa_l.svg"]
                    })
                cityLocations.push(
                    {
                        "city": "South Chicago", 
                        "latitude": 41.5781136, 
                        "longitude": -87.6297982, 
                        "state": "Illinois",
                        "logos": ["logos/light/chicagows_l.svg"]

                    })

                map.selectAll("image").data(cityLocations)
                    .join("image")
                    .attr("opacity", 0.9)
                    .attr("height", "20px")
                    .attr("width", "20px")
                    .attr("x", d => projection([d['longitude'], d['latitude']])[0] - 10 )
                    .attr("y", d => projection([d['longitude'], d['latitude']])[1] - 10 )
                    .attr("href", d => d['logos'][0])
                    .attr("data-city", d => d['city'])
            }
            load();
        </script>
    </body>
</html>