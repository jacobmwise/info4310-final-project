<!DOCTYPE html>
<html>
    <head>
        <title>INFO4310 Final Project - rcc263, jmw555</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>

        <style>
            html, body{
                background-color: black;

            }

            * {
                color: white;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }


            .nation {
                fill: slategray;
                stroke: white;
                stroke-width: 1px;
            }

            .outline {
                stroke: darkgrey;
                stroke-width: 0.5px;
                fill: none;
            }

            /* .state{
                cursor: pointer;
            } */

        </style>
    </head>
    <body>
        <div style="text-align: center;">
            <h1>Moneyball</h1>
            <h3>Visualizing the Recent MLB Payroll Disparity, its Reasons, and its Effects</h3>

            <svg id="scatterplot" width="500" height="500"></svg>

            <div id="sliderDiv" style="display: flex; flex-direction: column;">
                <div id="slider"></div>
            </div>

            <svg id="choropleth" height="670" width="975"></svg>
        </div>
        <script>
            const load = async function() {
                let payrollData = await d3.csv("data/payroll.csv");
                let gdpData = await d3.csv("data/gdp.csv");
                let populationData = await d3.csv("data/population.csv");
                let winsData = await d3.csv("data/wins.csv");

                let cityLocationsRaw = await d3.json("data/cities.json");

                payrollData.forEach(d => {
                    if (d['Total Payroll'].slice(0,1) === '$') {
                        d['Total Payroll'] = d['Total Payroll'].slice(1)
                    }
                    if (d['Total Payroll'].slice(-1) === 'M') {
                        let decimalIndex = d['Total Payroll'].indexOf('.')
                        let mIndex = d['Total Payroll'].indexOf('M')
                        d['Total Payroll'] = d['Total Payroll'].slice(0,decimalIndex) + ',' + d['Total Payroll'].slice(decimalIndex + 1, mIndex)
                        if (d['Total Payroll'].length === 5) {
                            d['Total Payroll'] = d['Total Payroll'] + '0,000'
                        } else {
                            d['Total Payroll'] = d['Total Payroll'] + ',000'
                        }
                    }
                    d['Total Payroll'] = Number(d['Total Payroll'].split(',').join(''))
                    let team = winsData.filter((x) => { return (x['Team']===d['Team']) });
                    d['Win%'] = team[0][d['Year']]
                });
                console.log(payrollData);

                // SCATTER PLOT
                function makeScatter(year) {
                    let payrollExtent = d3.extent(payrollData, d => d['Total Payroll']);
                    let winsExtent = d3.extent(winsData, d => d[year]);

                    const scatterplot = d3.select("#scatterplot");
                    const scatterWidth = scatterplot.attr("width");
                    const scatterHeight = scatterplot.attr("height");
                    const scatterMargin = { top: 50, right: 50, bottom: 50, left: 50};
                    const scatterAreaWidth = scatterWidth - scatterMargin.left - scatterMargin.right;
                    const scatterAreaHeight = scatterHeight - scatterMargin.top - scatterMargin.bottom;

                    let annotations = scatterplot.append("g").attr("id","annotations");
                    const scatter = scatterplot.append("g")

                    let winsScale = d3.scaleLinear().domain(winsExtent).range([scatterAreaHeight, 0]);
                    let leftAxis = d3.axisLeft(winsScale)
                    let leftGridlines = d3.axisLeft(winsScale)
                                        .tickSize(-scatterAreaWidth-10)
                                        .tickFormat("")
                    let leftGridlinesG = annotations.append("g")
                        .attr("class", "y gridlines")
                        .attr("transform",`translate(${scatterMargin.left-10},${scatterMargin.top})`)
                        .call(leftGridlines);
                    let leftAxisG = annotations.append("g")
                        .attr("class", "y axis")
                        .attr("transform",`translate(${scatterMargin.left-10},${scatterMargin.top})`)
                        .call(leftAxis)

                    let payrollScale = d3.scaleLinear().domain(payrollExtent).range([0, scatterAreaWidth])
                    let bottomAxis = d3.axisBottom(payrollScale)
                    let bottomGridlines = d3.axisBottom(payrollScale)
                                            .tickSize(-scatterAreaHeight-10)
                                            .tickFormat("")
                    let bottomGridlinesG = annotations.append("g")
                        .attr("class", "x gridlines")
                        .attr("transform",`translate(${scatterMargin.left},${scatterAreaHeight+scatterMargin.top+10})`)
                        .call(bottomGridlines);
                    let bottomAxisG =  annotations.append("g")
                        .attr("class", "x axis")
                        .attr("transform",`translate(${scatterMargin.left},${scatterAreaHeight+scatterMargin.top+10})`)
                        .call(bottomAxis);

                    let circles = scatter.selectAll("circle.team")
                        .data(payrollData)
                        .join('circle').attr("class", "team")
                        .attr("value", d => d['Team'])
                        .attr("cx", d => payrollScale(d['Total Payroll']))
                        .attr("cy", d => winsScale(d['Win%']))
                        // .attr("r", 3.5)
                        .attr("r", 3.5)
                        .attr("fill", "white")
                        .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")");
                        // .attr("stroke", d=> secondaryColors(d['team']))
                        // .attr("stroke-width", "1.5px")
                        // .attr("fill", d=> primaryColors(d['team']))
                        // .style("opacity", .8)
                        // .attr("transform","translate("+scatterMargin.left+","+scatterMargin.top+")")
                        // .style("filter", function(d) {
                        //     if (topFive.includes(d)) {return "drop-shadow(2px 2px 10px rgba(240, 240, 0, 1))"}
                        //     else 	{ return "none" }
                        // ;})
                        // .style("cursor", "pointer")
                }
                makeScatter('2021');

                // SLIDER
                var slider = d3.select('div#slider').append('input')
                    .attr('type', 'range').attr('id', 'yearSlider').attr('step', 1)
                    .attr('min', 2011).attr('max', 2021)
                d3.select('div#slider').append('label').attr('id', 'sliderLabel').text('2021')
                slider.on('input', function(e) {
                    d3.select('label#sliderLabel').text(e.target.value);
                });
                d3.select('div#sliderDiv').append('label').text('Year')
                

                // MAP
                gdpData.forEach(metro => {
                    metro['2020'] = Number(metro['2020'])
                })

                let gdpExtent = d3.extent(gdpData, d => d['2020']);

                let gdpScale = d3.scaleLog().domain(gdpExtent).range([3, 25]);

                // console.log(gdpExtent)

                let cities = []
                let cityLocations = []

                populationData.forEach(city => {
                    if (!cities.includes(city['City'])){
                        cities.push(city['City'])
                    }
                })

                // console.log(cities)

                cityLocationsRaw.forEach(city => {
                    if (cities.includes(city['city'])){
                        gdpData.forEach(metro => {
                            if (metro['Metropolitan Area'].includes(city['city'])){
                                city['gdp'] = metro['2020']
                                // console.log(metro['2020'])
                            }
                        })
                        cityLocations.push(city)
                    } 
                    // console.log(city['city'])
                })
                

                payrollData.forEach(d => {
                    if (d['Playoffs'] === "") {
                        d['Playoffs'] = "N"
                    }
                });
                // console.log(payrollData);
                // console.log(gdpData);
                // console.log(populationData);
                // console.log(winsData);

                const map = d3.select("#choropleth")

                const us = await d3.json("/data/counties-10m.json");
                var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
                var path = d3.geoPath().projection(projection);

                var nation = topojson.feature(us, us.objects.nation);
                var states = topojson.feature(us, us.objects.states);
                var statesMesh = topojson.mesh(us, us.objects.states);

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                // console.log(cityLocations)

                map.selectAll("circle").data(cityLocations)
                    .join("circle")
                    // .attr("r", d => diameterScale(d['DBH']))
                    .attr("r", d => gdpScale(d['gdp']))
                    .attr("opacity", 0.6)
                    // .attr("fill", d => speciesScale(d['qSpecies']))
                    .attr("fill", "red")
                    .attr("cx", d => projection([d['longitude'], d['latitude']])[0])
                    .attr("cy", d => projection([d['longitude'], d['latitude']])[1])
                    .attr("data-city", d => d['city'])
                    .attr("stroke", "white")
            }
            load();
        </script>
    </body>
</html>